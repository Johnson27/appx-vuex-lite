'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.setIn=undefined;var _assign=require('babel-runtime/core-js/object/assign');var _assign2=_interopRequireDefault(_assign);var _extends=_assign2.default||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c){if(Object.prototype.hasOwnProperty.call(c,d)){a[d]=c[d]}}}return a};exports.storeHelper=storeHelper;exports.connect=connect;exports.default=Store;var _emitter=require('./emitter');var _emitter2=_interopRequireDefault(_emitter);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _ExternalPromiseCached;function _ExternalPromise(){if(_ExternalPromiseCached)return _ExternalPromiseCached;if(typeof window!=='undefined'&&window.Promise&&typeof window.Promise.resolve==='function'){_ExternalPromiseCached=window.Promise}else{_ExternalPromiseCached=require('babel-runtime/core-js/promise').default||require('babel-runtime/core-js/promise')}return _ExternalPromiseCached}var actionsCache={};var emitter=new _emitter2.default;function logger(){return console.info.apply(this,arguments)}function isObject(a){return Object.prototype.toString.call(a)==='[object Object]'};function isString(a){return Object.prototype.toString.call(a)==='[object String]'};function _setIn(a,b,c){var d=function setRecursively(a,b,c,e){var f={};var g=b[e];var h=void 0;if(b.length>e){if(Array.isArray(a)){f=a.slice(0)}else{f=(0,_assign2.default)({},a)}h=a[g]!==undefined?a[g]:{};f[g]=d(h,b,c,e+1);return f}return c};return d(a,b,c,0)}exports.setIn=_setIn;var mutationCache={default:function _default(a){return a},setIn:function setIn(a,b){return _setIn(b,a.path,a.value)}};function createHelpers(a){return{commit:function commit(a,b){var c=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'default';if(!a){throw new Error('not found '+a+' action')}if(isObject(a)){b=a;a='update'}logger('%c prev state','color: #9E9E9E; font-weight: bold',this.data);logger('%c mutation: '+a,'color: #03A9F4; font-weight: bold',b,new Date().getTime());var d=mutationCache[c]?mutationCache[c](b,this.data):c(b,this.data);this.setData(d);emitter.emitEvent('updateState',this.data);logger('%c next state','color: #4CAF50; font-weight: bold',this.data);return this.data},dispatch:function dispatch(b,c){console.log('tt',this);var d=(0,_assign2.default)({},a,this);var e=d[b];if(!e){throw new Error('not found an action')}var f=this;logger('%c action '+b+' dispatching','color: #9E9E9E; font-weight: bold',c);var g=e.call(f,{commit:this.commit.bind(f),dispatch:this.dispatch.bind(f),put:function put(a){var b=d[a];if(!b){throw new Error('not found '+a+' action')}if(b){for(var c=arguments.length,e=Array(c>1?c-1:0),g=1;g<c;g++){e[g-1]=arguments[g]}b.apply(f,e)}},get state(){return f.data}},c);if(g instanceof _ExternalPromise()){return g}return _ExternalPromise().resolve(g)}}}function storeHelper(a,b){return _extends({},b,createHelpers.call(this,a))}function connect(a){var b=a.mapStateToProps;return function(a){var c=a.didMount;return _extends({},a,{methods:_extends({},a.methods,createHelpers.call(this,actionsCache)),didMount:function didMount(){var d=this;if(b){emitter.addListener('updateState',function(){var c=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(Array.isArray(b)){var e=b.reduce(function(a,b){a[b]=c[b];return a},{});d.setData(e)}else{var f=Object.keys(b).reduce(function(d,e){if(isString(b[e])){d[e]=c[b[e]]}else{d[e]=b[e](c,a)}return d},{});d.setData(f)}})}if(typeof c==='function'){c.call(this)}}})}}function Store(a,b){var c=a.actions||a;(0,_assign2.default)(actionsCache,c);var d=a.state||{};return function(a){var b=a.data,e=b===undefined?{}:b;(0,_assign2.default)(e,d);var f=a.onLoad;a.onLoad=function(){Object.defineProperty(this,'state',{get:function get(){return this.data}});if(f){f.apply(this,arguments)}};return storeHelper(c,a)}}